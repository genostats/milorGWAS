---
title: "milorGWAS package"
subtitle: 'Version 0.2'
author: "Hervé Perdry, Jacqueline Milet"
version: 0.2
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{milorGWAS package}
  %\VignetteDepends{milorGWAS}
  %\VignettePackage{milorGWAS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction



## Running `association.test.logistic`

```{r echo=TRUE, message=FALSE, results="hide"}
require(milorGWAS)
```

```{r example1}
data(TTN)
x <- as.bed.matrix(TTN.gen, TTN.fam, TTN.bim)
standardize(x) <- "p"
## Simulation data ##
set.seed(1)
# some covariables
X <- cbind(1, runif(nrow(x)))
# A GRM
ran <- random.pm( nrow(x))
# the random effects (tau = 1)
omega <- lmm.simu(1, 0, eigenK=ran$eigen)$omega
# linear term of the model
lin <- X %*% c(0.1,-0.2) + omega
# vector of probabilitues
pi <- 1/(1+exp( -lin ))
# vector of binary phenotypes
y <- rbinom(nrow(x), 1, pi)
# testing association with 1) the score test, 2) the offset algorithm, 3) the 'amle' algorithm
a0 <- association.test(x, y, X, K = ran$K, method = "lmm", response = "bin", test = "wald",  verbose= FALSE)
a1 <- association.test(x, y, X, K = ran$K, method = "lmm", response = "bin", test = "score", verbose= FALSE)
a2 <- association.test.logistic(x, y, X, K = ran$K, algorithm = "offset", verbose = FALSE)
a3 <- association.test.logistic(x, y, X, K = ran$K, algorithm = "amle", verbos = FALSE)
```

## Application to a simulated structured population


Cohort 10000 ind simulée avec ms - structure de pop similaire à la pop européenne - fichier "Cohort10K_3Msnps_EU_ms"
simu sous Ho : du phénotype CT avec effet apparentement + un effet environnemental (pop avec un risque plus éléve dans la partie sup gauche de la grille - similaire à Chen)


```{r eval=FALSE}
install.packages("GridData", repos="https://genostats.github.io/R/")
```

```{r}
filepath <-system.file("extdata", "GridData.bed", package="GridData")
x <- read.bed.matrix(filepath)
x <- set.stats(x)
```

```{r GRM, cache=TRUE}
# GRM definition on a subsample of 100K snps 
x2<-x[,sample(1:nrow(x@snps), 100000)]
K <- GRM(x2)
eigenK <- eigen(K)
```


```{r associationTests, cache=TRUE}
# GWA 
# All analysis were performed including 10 PCs

# tests from gaston package 
# logistic regression 
LR<-association.test(x, method = "lm", response = "binary",    test = "wald", eigenK=eigenK, p=10)

# mixed linear model 
MLM<-association.test(x, method = "lmm", response = "quantitative",    test = "wald", eigenK=eigenK, p=10)

# mixed logistic regression 
MLR<-association.test(x, method = "lmm", response = "binary", K=K, eigenK=eigenK,  test = "score", p=10)

# Two methods to get SNPs'effect estimation within a mixed logistic regression, implemented in milorGWAS package 

# X is a matrix including the intercept and the first 10 PCs 
I  <-  matrix(rep(1,nrow(x@ped)))
X <- cbind(I,eigenK$vectors[,1:10])


AMLE<- association.test.logistic(x, X=X,  K=K, algorithm="amle", verbose=F)

Offset<-association.test.logistic(x, X=X, K=K, algorithm="offset", verbose=F)
```



```{r fig.height = 5, fig.width = 10, dev = 'png'}
# Stratified quantile-quantile plots 
# SNPs categories from variance ratio from strata
# strata information is contained in the variable pop of the bedmatrix (variable x@ped$pop coded 1/0)
SNP.category(x,x@ped$pop) -> cat.str

# SNPs categories from the first PCs coordinates
SNP.category(x,-eigenK$vectors[,1]) -> cat.PC1
SNP.category(x,-eigenK$vectors[,2]) -> cat.PC2
# Stratified QQplots
par(mfrow=c(2,6))
qqplot.pvalues(MLM, cat.str, col.abline="blue", cex=0.6, cex.lab=1, cex.axis=1, main="MLM - Variance ratio from strata")
qqplot.pvalues(MLM, cat.PC1, col.abline="blue", cex=0.6, cex.lab=1, cex.axis=1, main="MLM - Variance ratio from PC1")
qqplot.pvalues(MLM, cat.PC2, col.abline="blue", cex=0.6, cex.lab=1, cex.axis=1, main="MLM - Variance ratio from PC2")

qqplot.pvalues(MLR, cat.str, col.abline="blue", cex=0.6, cex.lab=1, cex.axis=1, main="MLR - Variance ratio from strata")
qqplot.pvalues(MLR, cat.PC1, col.abline="blue", cex=0.6, cex.lab=1, cex.axis=1, main="MLR - Variance ratio from PC1")
qqplot.pvalues(MLR, cat.PC1, col.abline="blue", cex=0.6, cex.lab=1, cex.axis=1, main="MLR - Variance ratio from PC2")
```
